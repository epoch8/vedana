version: "3.8"

services:
  memgraph:
    image: memgraph/memgraph-mage:latest
    ports:
      - "7687:7687"   # bolt
      - "7444:7444"   # logs
    command:
      [
        "--telemetry-enabled=false",
        "--storage-mode=IN_MEMORY_ANALYTICAL"
      ]
    healthcheck:
      test: ["CMD", "bash", "-lc", "echo 'RETURN 1;' | mgconsole --host=127.0.0.1 --port=7687 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  grist:
    image: gristlabs/grist:latest
    environment:
      # (пример из grist-local-testing; подходит только для CI/локала)
      GRIST_API_KEY: "e30d2f274a538c05fecd14510887f8a3b7eab718"
      GRIST_DATA_MODEL_DOC_ID: "aAco4qS9Dvf8"
      GRIST_DATA_DOC_ID: "kB1iVADLPGU5"
      GRIST_ORG_IN_PATH: "true"
      GRIST_DEFAULT_EMAIL: ci@example.com
      GRIST_SESSION_SECRET: dev-secret
    ports:
      - "8484:8484"
    volumes:
      # Where to store persistent data, such as documents.
      - ${PERSIST_DIR:-./persist}/grist:/persist
      # CSV-фикстуры, читаем их скриптом
      - ../fixtures/grist:/seed:ro
    healthcheck:
      test: ["CMD", "bash", "-lc", "wget -qO- http://localhost:8484/api/status || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 60
